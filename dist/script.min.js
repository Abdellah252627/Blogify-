 document.addEventListener('DOMContentLoaded',()=>{const state={theme:localStorage.getItem('theme')||'light',lang:localStorage.getItem('lang')||'en',articles:JSON.parse(localStorage.getItem('articles'))||[],currentPage:'home',userProfile:JSON.parse(localStorage.getItem('userProfile'))||{name:'John Doe',email:'john@example.com',bio:'Passionate blogger and writer',avatar:'https:},articleToDelete:null,comments:JSON.parse(localStorage.getItem('comments'))||{},currentArticleId:null,selectedTag:null,bookmarked:JSON.parse(localStorage.getItem('bookmarked'))||[],articleToEditId:null,};const themeToggleBtn=document.getElementById('theme-toggle-btn');const langToggleBtn=document.getElementById('lang-toggle-btn');const newArticleBtn=document.getElementById('new-article-btn');const aboutBtn=document.getElementById('about-btn');const logo=document.querySelector('.logo');const userProfileBtn=document.getElementById('user-profile-btn');const analyticsBtn=document.getElementById('analytics-btn');const progressBar=document.getElementById('progress-bar');const backToTopBtn=document.getElementById('back-to-top-btn');const tagCloud=document.getElementById('tag-cloud');const pages={home:document.getElementById('home-page'),editor:document.getElementById('editor-page'),about:document.getElementById('about-page'),detail:document.getElementById('article-detail-page'),profile:document.getElementById('user-profile-page'),analytics:document.getElementById('analytics-page'),bookmarks:document.getElementById('bookmarks-page')};const articlesGrid=document.getElementById('articles-grid');const articleForm=document.getElementById('article-form');const searchInput=document.getElementById('search-input');const categoryFilter=document.getElementById('category-filter');const richEditor=document.getElementById('rich-editor');const editorToolbar=document.getElementById('editor-toolbar');const linkBtn=document.getElementById('link-btn');const linkModal=document.getElementById('link-modal');const confirmLinkBtn=document.getElementById('confirm-link-btn');const cancelLinkBtn=document.getElementById('cancel-link-btn');const linkUrlInput=document.getElementById('link-url');const articleTitleInput=document.getElementById('article-title');const articleContentDetail=document.getElementById('article-content-detail');const commentsModal=document.getElementById('comments-modal');const commentsList=document.getElementById('comments-list');const commentForm=document.getElementById('comment-form');let autosaveInterval;let categoryChartInstance=null;const toolsMenuBtn=document.getElementById('tools-menu-btn');const toolsMenu=document.getElementById('tools-menu');const exportBtn=document.getElementById('export-btn');const importBtn=document.getElementById('import-btn');const importExportModal=document.getElementById('import-export-modal');const confirmExportBtn=document.getElementById('confirm-export-btn');const confirmImportBtn=document.getElementById('confirm-import-btn');const importFileInput=document.getElementById('import-file');const importSection=document.getElementById('import-section');const exportSection=document.getElementById('export-section');const importExportTitle=document.getElementById('import-export-title');const profileAvatarImg=document.getElementById('profile-avatar-img');const profileDisplayName=document.getElementById('profile-display-name');const profileBio=document.getElementById('profile-bio');const profileArticlesCount=document.getElementById('profile-articles-count');const profileViewsCount=document.getElementById('profile-views-count');const profileForm=document.getElementById('profile-form');const profileNameInput=document.getElementById('profile-name');const profileEmailInput=document.getElementById('profile-email');const profileBioInput=document.getElementById('profile-bio-input');const rssFeedBtn=document.getElementById('rss-feed-btn');const deleteConfirmModal=document.getElementById('delete-confirm-modal');const confirmDeleteBtn=document.getElementById('confirm-delete-btn');const cancelDeleteBtn=document.getElementById('cancel-delete-btn');const bookmarksBtn=document.getElementById('bookmarks-btn');const translations={en:{logo:"Blogify ðŸ“",new_article:"New Article",about:"About",recent_articles:"Recent Articles",write_article:"Write a New Article",title:"Title",content:"Content",publish:"Publish",no_articles:"No articles yet.Write one!",search_placeholder:"Search articles...",all_categories:"All Categories",category:"Category",tags:"Tags",save_draft:"Save Draft",back:"Back",category_placeholder:"e.g.,Technology,Lifestyle...",tags_placeholder:"e.g.,web,javascript,tutorial(comma separated)",export_articles:"Export Articles",import_articles:"Import Articles",download_export:"Download Export",import_description:"Import articles from a JSON file.Note:This will merge with existing articles.",export_description:"Export all your articles as a JSON file for backup or migration.",select_file:"Select File",articles_exported:"Articles exported successfully!",articles_imported:"Articles imported successfully!",no_file_selected:"No file selected.",invalid_file:"Invalid file format.Please select a valid JSON file.",user_profile:"User Profile",edit_profile:"Edit Profile",name:"Name",bio:"Bio",save_profile:"Save Profile",profile_saved:"Profile saved successfully!",rss_feed:"RSS Feed",comments:"Comments",view_comments:"View Comments",rss_feed_description:"Copy the link below to subscribe to our RSS feed.",feature_soon:"This feature is coming soon!",delete_article:"Delete Article",confirm_delete_title:"Confirm Deletion",confirm_delete_text:"Are you sure you want to delete this article?This action cannot be undone.",cancel:"Cancel",delete:"Delete",article_deleted:"Article deleted successfully.",add_link:"Add Link",link_url:"URL",draft_saved:"Draft saved!",draft_loaded:"Unsaved draft loaded.",add_comment:"Add Comment",submit_comment:"Submit Comment",no_comments_yet:"No comments yet.Be the first to comment!",comment_added:"Comment added successfully!",related_articles:"Related Articles",no_related_articles:"No related articles found.",bookmarks:"Bookmarks",bookmarked_articles:"Bookmarked Articles",no_bookmarks:"You haven't bookmarked any articles yet.",article_bookmarked:"Article bookmarked!",bookmark_removed:"Bookmark removed.",views:"Views",reading_time:"min read",popular_articles:"Popular Articles",views_by_category:"Views by Category",edit_article:"Edit Article",update_article:"Update Article",article_updated:"Article updated successfully!",editing_article:"Editing Article",article_published:"Article published successfully!",total_articles:"Total Articles",total_views:"Total Views",total_comments:"Total Comments",avg_reading_time:"Avg Reading Time",analytics_dashboard:"Analytics Dashboard",about_title:"About Blogify",about_text:"Blogify is a modern,interactive,and professional blogging platform.It supports both light and dark modes,language switching(Arabic/English)with animations,and local storage for your articles.This project is built with pure HTML,CSS,and JavaScript to be lightweight and fast.",keyboard_shortcuts:"Keyboard Shortcuts",shortcut_new_article:"New Article",shortcut_search:"Focus Search",shortcut_save:"Save Draft",shortcut_publish:"Publish Article",shortcut_escape:"Close/Cancel",shortcut_help:"Show Shortcuts",email:"Email"},ar:{logo:"ØªØ¯ÙˆÙŠÙ† ðŸ“",new_article:"Ù…Ù‚Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",about:"Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹",recent_articles:"Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª",write_article:"Ø§ÙƒØªØ¨ Ù…Ù‚Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",title:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",content:"Ø§Ù„Ù…Ø­ØªÙˆÙ‰",publish:"Ù†Ø´Ø±",no_articles:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.Ø§ÙƒØªØ¨ ÙˆØ§Ø­Ø¯Ø©!",search_placeholder:"Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª...",all_categories:"Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª",category:"Ø§Ù„ØªØµÙ†ÙŠÙ",tags:"Ø§Ù„ÙˆØ³ÙˆÙ…",save_draft:"Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©",back:"Ø±Ø¬ÙˆØ¹",category_placeholder:"Ù…Ø«Ù„Ø§Ù‹:Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ØŒ Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©...",tags_placeholder:"Ù…Ø«Ù„Ø§Ù‹:ÙˆÙŠØ¨ØŒ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨ØªØŒ Ø¯Ø±Ø³(ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)",export_articles:"ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª",import_articles:"Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª",download_export:"ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªØµØ¯ÙŠØ±",import_description:"Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù† Ù…Ù„Ù JSON.Ù…Ù„Ø§Ø­Ø¸Ø©:Ø³ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",export_description:"ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ù…Ù‚Ø§Ù„Ø§ØªÙƒ ÙƒÙ…Ù„Ù JSON Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø£Ùˆ Ø§Ù„ØªØ±Ø­ÙŠÙ„.",select_file:"Ø§Ø®ØªØ± Ù…Ù„Ù",articles_exported:"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!",articles_imported:"ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!",no_file_selected:"Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù.",invalid_file:"ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON ØµØ§Ù„Ø­.",user_profile:"Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",edit_profile:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",name:"Ø§Ù„Ø§Ø³Ù…",bio:"Ù†Ø¨Ø°Ø© ØªØ¹Ø±ÙŠÙÙŠØ©",save_profile:"Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",profile_saved:"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­!",rss_feed:"ØªØºØ°ÙŠØ© RSS",comments:"Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª",view_comments:"Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª",rss_feed_description:"Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØºØ°ÙŠØ© RSS Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§.",feature_soon:"Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ØªØªÙˆÙØ± Ù‚Ø±ÙŠØ¨Ù‹Ø§!",delete_article:"Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„Ø©",confirm_delete_title:"ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",confirm_delete_text:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.",cancel:"Ø¥Ù„ØºØ§Ø¡",delete:"Ø­Ø°Ù",article_deleted:"ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.",add_link:"Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·",link_url:"Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø·",draft_saved:"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©!",draft_loaded:"ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø© ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©.",add_comment:"Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§",submit_comment:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚",no_comments_yet:"Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚!",comment_added:"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!",related_articles:"Ù…Ù‚Ø§Ù„Ø§Øª Ø°Ø§Øª ØµÙ„Ø©",no_related_articles:"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù‚Ø§Ù„Ø§Øª Ø°Ø§Øª ØµÙ„Ø©.",bookmarks:"Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª",bookmarked_articles:"Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©",no_bookmarks:"Ù„Ù… ØªÙ‚Ù… Ø¨Ø­ÙØ¸ Ø£ÙŠ Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.",article_bookmarked:"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©!",bookmark_removed:"ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©.",views:"Ù…Ø´Ø§Ù‡Ø¯Ø§Øª",reading_time:"Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø±Ø§Ø¡Ø©",popular_articles:"Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§",views_by_category:"Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©",edit_article:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©",update_article:"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„Ø©",article_updated:"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!",editing_article:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©",article_published:"ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!",total_articles:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª",total_views:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª",total_comments:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª",avg_reading_time:"Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©",analytics_dashboard:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª",about_title:"Ø­ÙˆÙ„ ØªØ¯ÙˆÙŠÙ†",about_text:"ØªØ¯ÙˆÙŠÙ† Ù‡Ùˆ Ù…Ù†ØµØ© ØªØ¯ÙˆÙŠÙ† Ø­Ø¯ÙŠØ«Ø© ÙˆØªÙØ§Ø¹Ù„ÙŠØ© ÙˆÙ…Ù‡Ù†ÙŠØ©.ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ÙØ§ØªØ­Ø© ÙˆØ§Ù„Ù…Ø¸Ù„Ù…Ø©ØŒ ÙˆØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©(Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)Ù…Ø¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©ØŒ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù…Ù‚Ø§Ù„Ø§ØªÙƒ.ØªÙ… Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HTML Ùˆ CSS Ùˆ JavaScript Ø§Ù„Ø®Ø§Ù„Øµ Ù„ÙŠÙƒÙˆÙ† Ø®ÙÙŠÙ Ø§Ù„ÙˆØ²Ù† ÙˆØ³Ø±ÙŠØ¹.",keyboard_shortcuts:"Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­",shortcut_new_article:"Ù…Ù‚Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",shortcut_search:"Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«",shortcut_save:"Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©",shortcut_publish:"Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„Ø©",shortcut_escape:"Ø¥ØºÙ„Ø§Ù‚/Ø¥Ù„ØºØ§Ø¡",shortcut_help:"Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª",email:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"}};let imageObserver;function setupImageObserver(){const observerOptions={root:null,rootMargin:'0px',threshold:0.1};imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;const src=img.getAttribute('data-src');if(src){img.src=src;img.removeAttribute('data-src');img.classList.add('loaded');}observer.unobserve(img);}});},observerOptions);}function updateProgressBar(){if(state.currentPage==='detail'&&articleContentDetail){const articleContent=articleContentDetail.querySelector('.article-detail-content');if(!articleContent){progressBar.style.width='0%';return;}const elementTop=articleContent.offsetTop;const elementHeight=articleContent.clientHeight;const viewportHeight=window.innerHeight;const totalScrollableHeight=elementHeight-viewportHeight;const scrolledFromTop=window.scrollY-elementTop;if(scrolledFromTop<0){progressBar.style.width='0%';}else if(scrolledFromTop>totalScrollableHeight){progressBar.style.width='100%';}else{const progressPercentage=(scrolledFromTop/totalScrollableHeight)*100;progressBar.style.width=`${progressPercentage}%`;}}else{progressBar.style.width='0%';}}function handleScroll(){if(window.scrollY>200){backToTopBtn.classList.add('visible');}else{backToTopBtn.classList.remove('visible');}}function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'});}function init(){try{applyTheme();applyLanguage();renderArticles();setupEventListeners();updateCategoryFilter();renderTagCloud();setupImageObserver();}catch(error){console.error('Error during initialization:',error);showToast('Application initialization failed','error');}}function applyTheme(){document.documentElement.classList.toggle('dark',state.theme==='dark');localStorage.setItem('theme',state.theme);themeToggleBtn.textContent=state.theme==='dark'?'â˜€ï¸' :'ðŸŒ™';}function toggleTheme(){state.theme=state.theme==='light'?'dark' :'light';applyTheme();}function applyLanguage(){document.documentElement.lang=state.lang;document.documentElement.dir=state.lang==='ar'?'rtl' :'ltr';localStorage.setItem('lang',state.lang);document.querySelectorAll('[data-lang-key]').forEach(el=>{const key=el.getAttribute('data-lang-key');if(translations[state.lang]&&translations[state.lang][key]){el.textContent=translations[state.lang][key];}});langToggleBtn.textContent=state.lang==='ar'?'En' :'Ø¹';}function toggleLanguage(){state.lang=state.lang==='en'?'ar' :'en';applyLanguage();renderArticles();updateCategoryFilter();}function navigateTo(pageName){Object.values(pages).forEach(page=>{if(page)page.classList.remove('active');});if(pages[pageName]){pages[pageName].classList.add('active');state.currentPage=pageName;updateProgressBar();if(pageName==='profile'){renderUserProfile();}if(pageName==='analytics'){renderAnalytics();}if(pageName==='editor'){const h2=pages.editor.querySelector('h2');const submitBtn=pages.editor.querySelector('#publish-btn');if(state.articleToEditId){const article=state.articles.find(a=>a.id===state.articleToEditId);if(article){document.getElementById('article-title').value=article.title;document.getElementById('rich-editor').innerHTML=article.content;document.getElementById('article-category').value=article.category;document.getElementById('article-tags').value=article.tags.join(',');h2.textContent=translations[state.lang].editing_article;submitBtn.textContent=translations[state.lang].update_article;}}else{articleForm.reset();document.getElementById('rich-editor').innerHTML='';h2.textContent=translations[state.lang].write_article;submitBtn.textContent=translations[state.lang].publish;}startAutosave();}else{stopAutosave();}if(pageName==='bookmarks'){renderBookmarkedArticles();}}else{console.warn(`Page "${pageName}" not found.`);}}function saveArticles(){try{localStorage.setItem('articles',JSON.stringify(state.articles));}catch(error){console.error('Failed to save articles to localStorage:',error);showToast('Failed to save articles.Storage may be full.','error');}}function formatDate(dateString){const date=new Date(dateString);return date.toLocaleDateString(state.lang==='ar'?'ar-SA' :'en-US',{year:'numeric',month:'short',day:'numeric'});}function getUniqueCategories(){const categories=new Set();state.articles.forEach(article=>{if(article.category){categories.add(article.category.trim());}});return Array.from(categories);}function updateCategoryFilter(){const categories=getUniqueCategories();if(categoryFilter){categoryFilter.innerHTML=`<option value="">${translations[state.lang].all_categories}</option>`;categories.forEach(category=>{const option=document.createElement('option');option.value=category;option.textContent=category;categoryFilter.appendChild(option);});}}function getAllTags(){const tagCounts={};state.articles.forEach(article=>{article.tags.forEach(tag=>{tagCounts[tag]=(tagCounts[tag]||0)+1;});});return tagCounts;}function renderTagCloud(){if(!tagCloud)return;const tags=getAllTags();tagCloud.innerHTML='';Object.keys(tags).forEach(tag=>{const tagEl=document.createElement('span');tagEl.className='tag';tagEl.textContent=tag;if(tag===state.selectedTag){tagEl.classList.add('active');}tagEl.addEventListener('click',()=>{if(state.selectedTag===tag){state.selectedTag=null;}else{state.selectedTag=tag;}renderArticles();renderTagCloud();});tagCloud.appendChild(tagEl);});}function filterArticles(){const searchTerm=searchInput?searchInput.value.toLowerCase():'';const selectedCategory=categoryFilter?categoryFilter.value :'';return state.articles.filter(article=>{const matchesSearch=!searchTerm||article.title.toLowerCase().includes(searchTerm)||article.content.toLowerCase().includes(searchTerm);const matchesCategory=!selectedCategory||article.category===selectedCategory;const matchesTag=!state.selectedTag||article.tags.includes(state.selectedTag);return matchesSearch&&matchesCategory&&matchesTag;});}function renderArticles(){if(!articlesGrid)return;const filteredArticles=filterArticles();articlesGrid.innerHTML='';if(filteredArticles.length===0){articlesGrid.innerHTML=`<p class="empty-state">${translations[state.lang].no_articles}</p>`;return;}filteredArticles.forEach(article=>{const card=document.createElement('div');card.className='article-card';const tagsHTML=article.tags.map(tag=>`<span class="tag">${tag}</span>`).join('');card.innerHTML=`<div class="card-content"><h3>${article.title}</h3><p>${article.content.substring(0,150).replace(/<[^>]*>/g,'')}...</p></div><div class="article-meta"><div class="tags-container">${tagsHTML}</div>${article.category?`<span class="category-tag">${article.category}</span>` :''}<span class="publish-date">${formatDate(article.publishDate)}</span></div>`;card.addEventListener('click',(e)=>{if(e.target.classList.contains('tag')){state.selectedTag=e.target.textContent;renderArticles();renderTagCloud();return;}viewArticle(article.id)});articlesGrid.appendChild(card);});}function saveComments(){try{localStorage.setItem('comments',JSON.stringify(state.comments));}catch(error){console.error('Failed to save comments to localStorage:',error);showToast('Failed to save comments.Storage may be full.','error');}}function renderComments(articleId){commentsList.innerHTML='';const articleComments=state.comments[articleId]||[];if(articleComments.length===0){commentsList.innerHTML=`<p class="empty-comments">${translations[state.lang].no_comments_yet}</p>`;return;}articleComments.forEach(comment=>{const commentEl=document.createElement('div');commentEl.className='comment-item';commentEl.innerHTML=`<div class="comment-header"><span class="comment-author">${comment.author}</span><span class="comment-date">${formatDate(comment.date)}</span></div><p class="comment-content">${comment.content}</p>`;commentsList.appendChild(commentEl);});}function handleCommentSubmit(e){e.preventDefault();const authorInput=document.getElementById('comment-author');const contentInput=document.getElementById('comment-content');const newComment={author:authorInput.value.trim(),content:contentInput.value.trim(),date:new Date().toISOString()};if(!newComment.author||!newComment.content)return;if(!state.comments[state.currentArticleId]){state.comments[state.currentArticleId]=[];}state.comments[state.currentArticleId].push(newComment);saveComments();renderComments(state.currentArticleId);showToast(translations[state.lang].comment_added);commentForm.reset();}function findRelatedArticles(currentArticle){const related=[];const maxRelated=3;if(currentArticle.category){state.articles.forEach(article=>{if(article.id!==currentArticle.id&&article.category===currentArticle.category){related.push(article);}});}if(related.length<maxRelated&&currentArticle.tags.length>0){state.articles.forEach(article=>{if(article.id!==currentArticle.id&&!related.some(r=>r.id===article.id)){const commonTags=article.tags.filter(tag=>currentArticle.tags.includes(tag));if(commonTags.length>0){related.push(article);}}});}const uniqueRelated=[...new Map(related.map(item=>[item['id'],item])).values()];return uniqueRelated.slice(0,maxRelated);}function renderRelatedArticles(articles){const container=document.getElementById('related-articles-grid');if(!container)return;container.innerHTML='';if(articles.length===0){container.innerHTML=`<p>${translations[state.lang].no_related_articles}</p>`;return;}articles.forEach(article=>{const card=document.createElement('div');card.className='related-article-card';card.innerHTML=`<div class="card-content"><h4>${article.title}</h4><span class="publish-date">${formatDate(article.publishDate)}</span></div>`;card.addEventListener('click',()=>viewArticle(article.id));container.appendChild(card);});}function viewArticle(articleId){state.currentArticleId=articleId;const article=state.articles.find(a=>a.id===articleId);if(!article)return;article.views=(article.views||0)+1;saveArticles();const readingTime=calculateReadingTime(article.content);const readingTimeEl=document.getElementById('reading-time');if(readingTimeEl){readingTimeEl.textContent=readingTime;}const relatedArticles=findRelatedArticles(article);renderRelatedArticles(relatedArticles);window.scrollTo(0,0);if(articleContentDetail){const isBookmarked=state.bookmarked.includes(articleId);const actionsBar=document.querySelector('#article-detail-page.article-actions-bar');if(actionsBar){const oldBtn=actionsBar.querySelector('.bookmark-btn');if(oldBtn)oldBtn.remove();const bookmarkBtn=document.createElement('button');bookmarkBtn.className=`bookmark-btn${isBookmarked?'bookmarked' :''}`;bookmarkBtn.innerHTML=isBookmarked?'â˜…' :'â˜†';bookmarkBtn.title="Bookmark";bookmarkBtn.addEventListener('click',()=>toggleBookmark(articleId));actionsBar.prepend(bookmarkBtn);}const tagsHTML=article.tags.map(tag=>`<span class="tag">${tag}</span>`).join('');articleContentDetail.innerHTML=`<article class="article-detail-content"><h1>${article.title}</h1><div class="article-meta"><div class="tags-container">${tagsHTML}</div>${article.category?`<span class="category-tag">${article.category}</span>` :''}<span class="publish-date">${formatDate(article.publishDate)}</span></div><div class="article-content">${article.content}</div><div class="article-footer"><button class="btn" id="view-comments-btn" data-lang-key="view_comments">View Comments</button><button class="btn btn-danger" id="delete-article-btn" data-lang-key="delete_article">Delete Article</button></div></article>`;const articleFooter=articleContentDetail.querySelector('.article-footer');if(articleFooter){const oldEditBtn=articleFooter.querySelector('.edit-article-btn');if(oldEditBtn)oldEditBtn.remove();const editBtn=document.createElement('button');editBtn.className='btn btn-secondary edit-article-btn';editBtn.textContent=translations[state.lang].edit_article;editBtn.addEventListener('click',()=>{state.articleToEditId=articleId;navigateTo('editor');});articleFooter.appendChild(editBtn);}const images=articleContentDetail.querySelectorAll('img[data-src]');images.forEach(img=>imageObserver.observe(img));const viewCommentsBtn=document.getElementById('view-comments-btn');if(viewCommentsBtn){viewCommentsBtn.addEventListener('click',()=>{renderComments(articleId);openModal(commentsModal);});}const deleteArticleBtn=document.getElementById('delete-article-btn');if(deleteArticleBtn){deleteArticleBtn.addEventListener('click',()=>{state.articleToDelete=articleId;openModal(deleteConfirmModal);});}try{articleContentDetail.querySelectorAll('.tag').forEach(tagEl=>{tagEl.addEventListener('click',()=>{state.selectedTag=tagEl.textContent;navigateTo('home');renderArticles();renderTagCloud();});});}catch(error){console.warn('Error setting up tag listeners:',error);}}navigateTo('detail');}function deleteArticle(){if(state.articleToDelete){state.articles=state.articles.filter(article=>article.id!==state.articleToDelete);saveArticles();renderArticles();showToast(translations[state.lang].article_deleted,'success');state.articleToDelete=null;closeModal(deleteConfirmModal);navigateTo('home');}}function executeCommand(command,value=null){document.execCommand(command,false,value);}function handleToolbarClick(e){const target=e.target.closest('[data-command]');if(target){const{command,value}=target.dataset;if(target.tagName==='SELECT'){target.onchange=()=>executeCommand(command,target.value);}else if(target.type==='color'){target.oninput=()=>executeCommand(command,target.value);}else{executeCommand(command,value);}}}function handleArticleSubmit(e){e.preventDefault();const title=document.getElementById('article-title').value.trim();const content=document.getElementById('rich-editor').innerHTML.trim();const category=document.getElementById('article-category').value.trim();const tags=document.getElementById('article-tags').value.trim();if(!title||!content)return;if(state.articleToEditId){const articleIndex=state.articles.findIndex(a=>a.id===state.articleToEditId);if(articleIndex>-1){const article=state.articles[articleIndex];article.title=title;article.content=content;article.category=category;article.tags=tags?tags.split(',').map(tag=>tag.trim()).filter(tag=>tag):[];}showToast(translations[state.lang].article_updated);state.articleToEditId=null;}else{const newArticle={id:Date.now(),title,content,category,tags:tags?tags.split(',').map(tag=>tag.trim()).filter(tag=>tag):[],publishDate:new Date().toISOString(),views:0};state.articles.unshift(newArticle);showToast(translations[state.lang].article_published);}saveArticles();renderArticles();updateCategoryFilter();renderTagCloud();articleForm.reset();document.getElementById('rich-editor').innerHTML='';navigateTo('home');}function saveUserProfile(){localStorage.setItem('userProfile',JSON.stringify(state.userProfile));}function renderUserProfile(){if(!pages.profile)return;const{name,email,bio,avatar}=state.userProfile;if(profileAvatarImg)profileAvatarImg.src=avatar;if(profileDisplayName)profileDisplayName.textContent=name;if(profileBio)profileBio.textContent=bio;if(profileNameInput)profileNameInput.value=name;if(profileEmailInput)profileEmailInput.value=email||'';if(profileBioInput)profileBioInput.value=bio;if(profileArticlesCount)profileArticlesCount.textContent=state.articles.length;if(profileViewsCount)profileViewsCount.textContent=state.articles.reduce((acc,article)=>acc+(article.views||0),0);}function handleProfileUpdate(e){e.preventDefault();state.userProfile.name=profileNameInput?profileNameInput.value.trim():'';state.userProfile.email=profileEmailInput?profileEmailInput.value.trim():'';state.userProfile.bio=profileBioInput?profileBioInput.value.trim():'';saveUserProfile();renderUserProfile();showToast(translations[state.lang].profile_saved);}function closeModal(modal){if(modal){modal.classList.remove('active');}}function openModal(modal){if(modal){modal.classList.add('active');}}function showToast(message,type='success'){const toast=document.createElement('div');toast.className=`toast${type}`;toast.textContent=message;let backgroundColor='#10b981';if(type==='error')backgroundColor='#ef4444';if(type==='info')backgroundColor='#3b82f6';toast.style.cssText=` position:fixed;top:2rem;right:2rem;padding:1rem 1.5rem;border-radius:0.5rem;color:white;font-weight:500;z-index:1000;animation:slideInRight 0.3s ease;background:${backgroundColor};`;document.body.appendChild(toast);setTimeout(()=>{toast.style.animation='slideOutRight 0.3s ease';setTimeout(()=>toast.remove(),300);},3000);}function handleExport(){const dataStr=JSON.stringify(state.articles,null,2);const dataBlob=new Blob([dataStr],{type:'application/json'});const url=URL.createObjectURL(dataBlob);const link=document.createElement('a');link.href=url;link.download='blogify_articles_export.json';document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);showToast(translations[state.lang].articles_exported);closeModal(importExportModal);}function handleImport(){if(!importFileInput||!importFileInput.files){showToast('File input not available','error');return;}const file=importFileInput.files[0];if(!file){showToast(translations[state.lang].no_file_selected,'error');return;}if(file.size>10*1024*1024){showToast('File too large.Maximum size is 10MB.','error');return;}const reader=new FileReader();reader.onload=function(event){try{const importedArticles=JSON.parse(event.target.result);if(Array.isArray(importedArticles)){const validArticles=importedArticles.filter(article=>{return article&&typeof article.title==='string'&&typeof article.content==='string'&&article.id;});state.articles=[...state.articles,...validArticles.filter(impArt=>!state.articles.some(exArt=>exArt.id===impArt.id))];saveArticles();renderArticles();updateCategoryFilter();showToast(translations[state.lang].articles_imported);closeModal(importExportModal);}else{throw new Error("Invalid format");}}catch(error){console.error('Import error:',error);showToast(translations[state.lang].invalid_file,'error');}};reader.onerror=function(){showToast('Error reading file','error');};reader.readAsText(file);}function startAutosave(){if(autosaveInterval)clearInterval(autosaveInterval);autosaveInterval=setInterval(()=>{const draft={title:articleTitleInput.value,content:richEditor.innerHTML};localStorage.setItem('editorDraft',JSON.stringify(draft));showToast(translations[state.lang].draft_saved,'info');},10000);}function stopAutosave(){clearInterval(autosaveInterval);}function loadDraft(){const draft=JSON.parse(localStorage.getItem('editorDraft'));if(draft){articleTitleInput.value=draft.title;richEditor.innerHTML=draft.content;showToast(translations[state.lang].draft_loaded,'info');}}function clearDraft(){localStorage.removeItem('editorDraft');}function saveBookmarks(){localStorage.setItem('bookmarked',JSON.stringify(state.bookmarked));}function toggleBookmark(articleId){const articleIndex=state.bookmarked.indexOf(articleId);if(articleIndex>-1){state.bookmarked.splice(articleIndex,1);showToast(translations[state.lang].bookmark_removed,'info');}else{state.bookmarked.push(articleId);showToast(translations[state.lang].article_bookmarked,'success');}saveBookmarks();if(state.currentPage==='home')renderArticles();if(state.currentPage==='detail')viewArticle(articleId);if(state.currentPage==='bookmarks')renderBookmarkedArticles();}function renderBookmarkedArticles(){const container=document.getElementById('bookmarked-articles-grid');if(!container)return;const bookmarkedArticles=state.articles.filter(article=>state.bookmarked.includes(article.id));container.innerHTML='';if(bookmarkedArticles.length===0){container.innerHTML=`<p class="empty-state">${translations[state.lang].no_bookmarks}</p>`;return;}bookmarkedArticles.forEach(article=>{const card=document.createElement('div');card.className='article-card';const isBookmarked=state.bookmarked.includes(article.id);card.innerHTML=`<div class="card-header" style="display:flex;justify-content:space-between;align-items:center;"><h3>${article.title}</h3><button class="bookmark-btn${isBookmarked?'bookmarked' :''}" data-id="${article.id}" title="Bookmark">${isBookmarked?'â˜…' :'â˜†'}</button></div><p>${article.content.substring(0,150).replace(/<[^>]*>/g,'')}...</p><div class="article-meta"><span class="publish-date">${formatDate(article.publishDate)}</span></div>`;card.addEventListener('click',(e)=>{if(e.target.classList.contains('bookmark-btn')){e.stopPropagation();toggleBookmark(article.id);}else{viewArticle(article.id)}});container.appendChild(card);});}function calculateReadingTime(content){const wordsPerMinute=state.lang==='ar'?180 :200;const text=content.replace(/<[^>]*>/g,'');const wordCount=text.split(/\s+/).filter(word=>word.length>0).length;const minutes=Math.max(1,Math.ceil(wordCount/wordsPerMinute));return `${minutes}${translations[state.lang].reading_time}`;}function renderAnalytics(){if(state.currentPage!=='analytics')return;const totalArticles=state.articles.length;const totalViews=state.articles.reduce((sum,article)=>sum+(article.views||0),0);const totalComments=Object.values(state.comments).flat().length;const totalArticlesEl=document.getElementById('total-articles');const totalViewsEl=document.getElementById('total-views');const totalCommentsEl=document.getElementById('total-comments');if(totalArticlesEl)totalArticlesEl.textContent=totalArticles;if(totalViewsEl)totalViewsEl.textContent=totalViews;if(totalCommentsEl)totalCommentsEl.textContent=totalComments;const viewsByCategory={};state.articles.forEach(article=>{const category=article.category||'Uncategorized';viewsByCategory[category]=(viewsByCategory[category]||0)+(article.views||0);});const chartLabels=Object.keys(viewsByCategory);const chartData=Object.values(viewsByCategory);const categoryChartEl=document.getElementById('category-chart');if(!categoryChartEl){console.warn('Category chart canvas not found');return;}const categoryChartCtx=categoryChartEl.getContext('2d');if(categoryChartInstance){categoryChartInstance.destroy();}categoryChartInstance=new Chart(categoryChartCtx,{type:'doughnut',data:{labels:chartLabels,datasets:[{label:translations[state.lang].views,data:chartData,backgroundColor:['#3b82f6','#ef4444','#10b981','#f59e0b','#6366f1','#8b5cf6'],hoverOffset:4}]}});const popularArticles=[...state.articles].sort((a,b)=>(b.views||0)-(a.views||0)).slice(0,5);const popularListContainer=document.getElementById('popular-articles-list');if(!popularListContainer){console.warn('Popular articles list container not found');return;}popularListContainer.innerHTML='';popularArticles.forEach(article=>{const item=document.createElement('div');item.className='popular-article-item';item.innerHTML=`<span class="title">${article.title}</span><span class="views">${article.views||0}${translations[state.lang].views}</span>`;popularListContainer.appendChild(item);});}function setupEventListeners(){if(themeToggleBtn)themeToggleBtn.addEventListener('click',toggleTheme);if(langToggleBtn)langToggleBtn.addEventListener('click',toggleLanguage);if(newArticleBtn)newArticleBtn.addEventListener('click',()=>navigateTo('editor'));if(aboutBtn)aboutBtn.addEventListener('click',()=>navigateTo('about'));if(logo)logo.addEventListener('click',()=>navigateTo('home'));if(userProfileBtn)userProfileBtn.addEventListener('click',()=>navigateTo('profile'));if(analyticsBtn)analyticsBtn.addEventListener('click',()=>navigateTo('analytics'));if(bookmarksBtn){bookmarksBtn.addEventListener('click',()=>{navigateTo('bookmarks');renderBookmarkedArticles();});}if(articleForm)articleForm.addEventListener('submit',handleArticleSubmit);if(searchInput){let searchTimeout;searchInput.addEventListener('input',()=>{clearTimeout(searchTimeout);searchTimeout=setTimeout(renderArticles,300);});}if(categoryFilter)categoryFilter.addEventListener('change',renderArticles);document.addEventListener('click',(e)=>{if(e.target.classList.contains('back-btn')){navigateTo('home');}});if(richEditor){richEditor.addEventListener('focus',function(){if(this.innerHTML.trim()===''||this.innerHTML==='<br>'){this.innerHTML='';}});richEditor.addEventListener('blur',function(){if(this.innerHTML.trim()===''||this.innerHTML==='<br>'){this.innerHTML='';}});}document.addEventListener('keydown',(e)=>{if(e.ctrlKey||e.metaKey){switch(e.key){case 'n':e.preventDefault();navigateTo('editor');break;case 'f':e.preventDefault();if(searchInput)searchInput.focus();break;}}if(e.key==='Escape'){if(state.currentPage!=='home'){navigateTo('home');}}});if(toolsMenuBtn){toolsMenuBtn.addEventListener('click',(e)=>{e.stopPropagation();toolsMenuBtn.parentElement.classList.toggle('active');});}if(exportBtn){exportBtn.addEventListener('click',()=>{importSection.style.display='none';exportSection.style.display='block';importExportTitle.textContent=translations[state.lang].export_articles;openModal(importExportModal);toolsMenuBtn.parentElement.classList.remove('active');});}if(importBtn){importBtn.addEventListener('click',()=>{exportSection.style.display='none';importSection.style.display='block';importExportTitle.textContent=translations[state.lang].import_articles;openModal(importExportModal);toolsMenuBtn.parentElement.classList.remove('active');});}if(confirmExportBtn)confirmExportBtn.addEventListener('click',handleExport);if(confirmImportBtn)confirmImportBtn.addEventListener('click',handleImport);if(confirmDeleteBtn){confirmDeleteBtn.addEventListener('click',deleteArticle);}if(cancelDeleteBtn){cancelDeleteBtn.addEventListener('click',()=>{state.articleToDelete=null;closeModal(deleteConfirmModal);});}document.addEventListener('click',()=>{if(toolsMenuBtn&&toolsMenuBtn.parentElement.classList.contains('active')){toolsMenuBtn.parentElement.classList.remove('active');}});document.querySelectorAll('.modal.modal-close').forEach(btn=>{btn.addEventListener('click',()=>{closeModal(btn.closest('.modal'));});});if(profileForm)profileForm.addEventListener('submit',handleProfileUpdate);if(rssFeedBtn){rssFeedBtn.addEventListener('click',()=>{showToast(translations[state.lang].feature_soon,'info');toolsMenuBtn.parentElement.classList.remove('active');});}if(editorToolbar)editorToolbar.addEventListener('click',handleToolbarClick);if(linkBtn){linkBtn.addEventListener('click',()=>{openModal(linkModal);});}if(confirmLinkBtn){confirmLinkBtn.addEventListener('click',()=>{const url=linkUrlInput.value;if(url){executeCommand('createLink',url);linkUrlInput.value='';closeModal(linkModal);}});}if(cancelLinkBtn){cancelLinkBtn.addEventListener('click',()=>closeModal(linkModal));}if(commentForm){commentForm.addEventListener('submit',handleCommentSubmit);}window.addEventListener('scroll',updateProgressBar);window.addEventListener('scroll',handleScroll);if(backToTopBtn){backToTopBtn.addEventListener('click',scrollToTop);}}const style=document.createElement('style');style.textContent=`@keyframes slideInRight{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}@keyframes slideOutRight{from{transform:translateX(0);opacity:1;}to{transform:translateX(100%);opacity:0;}}.toast{animation:slideInRight 0.3s ease;}`;document.head.appendChild(style);init();});